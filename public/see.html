<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Nirma SEE Calculator | Dashboard</title>

  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #D32F2F;
      --primary-hover: #b71c1c;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --success-bg: #ecfdf5;
      --success-text: #047857;
      --warning-bg: #fffbeb;
      --warning-text: #b45309;
      --danger-bg: #fef2f2;
      --danger-text: #b91c1c;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
      background-size: 20px 20px;
      margin: 0;
      padding: 0;
      color: var(--text-main);
      padding-bottom: 40px;
    }

    /* --- Header & Nav --- */
    header {
      background: var(--card-bg);
      padding: 15px 20px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
    }
    .brand span { color: var(--primary); }
    .brand div { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-info { text-align: right; display: none; } /* Hidden on mobile */
    .user-info .name { font-weight: 600; font-size: 0.9rem; }
    .user-info .email { font-size: 0.75rem; color: var(--text-muted); }

    #userPhoto {
      width: 40px; height: 40px;
      border-radius: 50%;
      border: 2px solid var(--border);
      object-fit: cover;
    }

    .logout-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .logout-btn:hover { background: #e5e7eb; }

    /* --- Main Layout --- */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 15px;
    }

    /* SGPA Widget */
    .sgpa-card {
      background: linear-gradient(135deg, var(--primary), #b71c1c);
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 15px -3px rgba(211, 47, 47, 0.3);
    }
    .sgpa-label { font-size: 1rem; opacity: 0.9; }
    .sgpa-value { font-size: 2.5rem; font-weight: 800; line-height: 1; }

    /* Grid for Subjects */
    #subjects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
    }

    /* Subject Card Styling */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1.2rem;
      border-bottom: 1px solid var(--bg);
      padding-bottom: 10px;
      color: var(--text-main);
    }

    /* Input Rows */
    .field-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .field-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      flex: 1;
    }

    .input-wrapper {
      display: flex;
      align-items: center;
      background: var(--bg);
      border-radius: 8px;
      padding: 0 10px;
      width: 140px; /* Fixed width for alignment */
      border: 1px solid transparent;
      transition: 0.2s;
    }

    .input-wrapper:focus-within {
      background: white;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
    }

    .input-wrapper input {
      width: 100%;
      border: none;
      background: transparent;
      padding: 10px 5px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-main);
      text-align: right;
      outline: none;
    }

    .input-wrapper span {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-left: 5px;
      white-space: nowrap;
    }

    /* Target Grade Section */
    .target-grade-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px dashed var(--border);
    }

    /* Action Button */
    .btn-calc {
      width: 100%;
      margin-top: 15px;
      padding: 12px;
      background: var(--text-main);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-calc:active { opacity: 0.8; transform: scale(0.98); }

    /* Result Box */
    .result {
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .green { background: var(--success-bg); color: var(--success-text); border: 1px solid #a7f3d0; }
    .yellow { background: var(--warning-bg); color: var(--warning-text); border: 1px solid #fde68a; }
    .red { background: var(--danger-bg); color: var(--danger-text); border: 1px solid #fecaca; }

    /* FAQ Section */
    .faq-section {
        margin-top: 30px;
        background: white;
        padding: 0;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid var(--border);
        overflow: hidden;
    }
    .faq-header {
        padding: 20px 25px;
        background: #fafafa;
        border-bottom: 1px solid var(--border);
    }
    .faq-header h3 {
        margin: 0;
        color: var(--text-main);
        font-size: 1.1rem;
    }
    .faq-item {
        border-bottom: 1px solid var(--bg);
        cursor: pointer;
        transition: background 0.2s;
    }
    .faq-item:last-child {
        border-bottom: none;
    }
    .faq-item:hover {
        background: #fdfdfd;
    }
    .faq-question {
        padding: 20px 25px;
        font-weight: 600;
        color: var(--primary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }
    .faq-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        color: var(--text-muted);
    }
    .faq-item.active .faq-icon {
        transform: rotate(180deg);
        color: var(--primary);
    }
    .faq-answer {
        display: none;
        padding: 0 25px 25px 25px;
        font-size: 0.9rem;
        color: var(--text-muted);
        line-height: 1.6;
        animation: slideDown 0.3s ease;
    }
    .faq-item.active .faq-answer {
        display: block;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Flowchart CSS */
    .flowchart {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
        background: var(--bg);
        padding: 20px;
        border-radius: 12px;
        border: 1px dashed var(--border);
    }
    .step {
        text-align: center;
        width: 100%;
        max-width: 320px;
        position: relative;
    }
    .step-box {
        background: white;
        border: 1px solid var(--border);
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        color: var(--text-main);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
        z-index: 2;
    }
    .step-box.highlight {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    .step-desc {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 6px;
        background: rgba(255,255,255,0.5);
        padding: 4px;
        border-radius: 4px;
    }
    .arrow {
        font-size: 1.5rem;
        color: var(--text-muted);
        margin: 4px 0;
        line-height: 1;
        opacity: 0.5;
    }

    /* Disclaimer Section */
    .disclaimer-box {
        margin-top: 20px;
        padding: 20px;
        text-align: center;
        border-top: 1px solid var(--border);
        color: var(--text-muted);
        font-size: 0.75rem;
        line-height: 1.5;
    }
    .disclaimer-box strong {
        color: var(--text-main);
    }

    /* Mobile Breakpoints */
    @media (min-width: 768px) {
      .user-info { display: block; }
      .container { padding: 0 20px; }
    }
    
    @media (max-width: 480px) {
      #subjects { grid-template-columns: 1fr; } /* Stack cards on mobile */
      .input-wrapper { width: 120px; }
      .brand h1 { font-size: 1.1rem; }
      .brand div { display: none; } /* Hide tagline on tiny screens */
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">
      <h1>Nirma <span>SEE Calc</span></h1>
      <div>Internal Marks & Grade Predictor</div>
    </div>

    <div class="user-profile">
      <div class="user-info">
        <div class="name" id="userName">Student</div>
        <div class="email" id="userEmail">Loading...</div>
      </div>
      <img id="userPhoto" src="https://via.placeholder.com/40" alt="User">
      <button id="logout" class="logout-btn">Logout</button>
    </div>
  </header>

  <div class="container">
    
    <!-- Dashboard Stats -->
    <div class="sgpa-card">
      <div>
        <div class="sgpa-label">Estimated SGPA</div>
        <div style="font-size:0.85rem; opacity:0.8;">Based on targets</div>
      </div>
      <div id="sgpaBox" class="sgpa-value">0.00</div>
    </div>

    <!-- Subject Grid -->
    <div id="subjects"></div>

    <!-- FAQ Section with Flowchart -->
    <div class="faq-section">
        <div class="faq-header">
            <h3>Frequently Asked Questions</h3>
        </div>
        
        <div class="faq-item" onclick="toggleFaq(this)">
            <div class="faq-question">
                 <span>How is the calculation done?</span>
                 <span class="faq-icon">‚ñº</span>
            </div>
            <div class="faq-answer">
                <p>The calculator uses the official weightage distribution to first determine your current standing (Internal Marks) and then calculates the remaining marks needed in the final exam (SEE) to reach your target grade.</p>
                
                <!-- CSS Flowchart -->
                <div class="flowchart">
                    <div class="step">
                        <div class="step-box">1. Input Marks</div>
                        <div class="step-desc">Sessional, Assignment, Lab, LPW</div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="step">
                        <div class="step-box">2. Calculate Internal (50%)</div>
                        <div class="step-desc">
                            <strong>Simple:</strong> (Sess/50)*25 + (Assgn/50)*25<br>
                            <strong>Complex:</strong> (Sess/50)*15 + (Assgn/50)*10 + (LAB/100)*15 + (LPW/40)*10
                        </div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="step">
                        <div class="step-box">3. Determine Target %</div>
                        <div class="step-desc">e.g., Grade 9 = 81% Total Aggregate Required</div>
                    </div>
                    <div class="arrow">‚Üì</div>
                    <div class="step">
                        <div class="step-box highlight">4. Final Formula</div>
                        <div class="step-desc">
                            (Target % - Internal Marks) √ó 2 = <strong>Required SEE Marks</strong>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Query Section (New) -->
    <div class="card" style="margin-top: 30px; text-align: center; border: 1px dashed var(--border);">
        <div style="font-weight: 600; font-size: 1rem; margin-bottom: 8px;">Is there any query?</div>
        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px;">
            Click below to send an email directly using your Nirma ID.
        </div>
        <a href="mailto:dhruvbhalala05@gmail.com" style="
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        " onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
            <span>üìß</span> Mail to dhruvbhalala05@gmail.com
        </a>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer-box">
        <strong>Disclaimer:</strong> This tool is created by a student for educational purposes only. 
        It is not an official Nirma University system. Calculations are approximate 
        and may differ from official results. Always verify with university guidelines.
    </div>
    
  </div>

  <script type="module">

    /* --------------------------
       Firebase Imports
    ---------------------------*/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    import { firebaseConfig } from "./firebase.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* --------------------------
       SUBJECT DEFINITIONS
    ---------------------------*/
    const gradeToPercent = { 10: 91, 9: 81, 8: 71, 7: 61, 6: 51, 5: 41, 4: 31, 3: 21, 2: 11, 1: 1 };

    const subjects = [
      { name: "Environmental Science", type: "simple" },
      { name: "Maths", type: "simple" },
      { name: "Physics", type: "complex" },
      { name: "Computer Programming", type: "complex" },
      { name: "Electrical Science", type: "complex" },
      { name: "General English", type: "complex" }
    ];

    const container = document.getElementById("subjects");

    /* --------------------------
       RENDER SUBJECT CARDS
    ---------------------------*/
    subjects.forEach((s, i) => {
      const id = "s" + i;
      const assignMax = s.type === "simple" ? 50 : 40;

      let html = `
      <div class="card">
        <div class="card-title">${s.name}</div>

        <div class="field-row">
          <span class="field-label">Sessional</span>
          <div class="input-wrapper">
            <input 
                type="number" 
                id="${id}_i1" 
                placeholder="0" 
                min="0" 
                max="50" 
                oninput="if(parseFloat(this.value) > 50) this.value = 50; if(parseFloat(this.value) < 0) this.value = 0;"
            >
            <span>/50</span>
          </div>
        </div>

        <div class="field-row">
          <span class="field-label">Assignment</span>
          <div class="input-wrapper">
            <input 
                type="number" 
                id="${id}_i2" 
                placeholder="0" 
                min="0"
                max="${assignMax}"
                oninput="if(parseFloat(this.value) > ${assignMax}) this.value = ${assignMax}; if(parseFloat(this.value) < 0) this.value = 0;"
            >
            <span>/${assignMax}</span>
          </div>
        </div>
      `;

      if (s.type === "complex") {
        html += `
        <div class="field-row">
          <span class="field-label">Lab Manual</span>
          <div class="input-wrapper">
            <input 
                type="number" 
                id="${id}_pract" 
                placeholder="0"
                min="0"
                max="100"
                oninput="if(parseFloat(this.value) > 100) this.value = 100; if(parseFloat(this.value) < 0) this.value = 0;"
            >
            <span>/100</span>
          </div>
        </div>

        <div class="field-row">
          <span class="field-label">LPW</span>
          <div class="input-wrapper">
            <input 
                type="number" 
                id="${id}_viva" 
                placeholder="0"
                min="0"
                max="40"
                oninput="if(parseFloat(this.value) > 40) this.value = 40; if(parseFloat(this.value) < 0) this.value = 0;"
            >
            <span>/40</span>
          </div>
        </div>
        `;
      }

      html += `
        <div class="field-row target-grade-section">
          <span class="field-label" style="font-weight:600; color:var(--text-main)">Target Grade</span>
          <div class="input-wrapper" style="border-color: #ddd;">
            <input 
                type="number" 
                id="${id}_grade" 
                placeholder="0" 
                step="1" 
                min="1" 
                max="10"
                oninput="this.value = Math.round(this.value); if(this.value > 10) this.value = 10;"
            >
            <span>/10</span>
          </div>
        </div>

        <button class="btn-calc" onclick="showRequired('${id}', ${i})">Calculate Required</button>

        <div id="${id}_result" class="result" style="display:none;"></div>

      </div>
      `;

      container.innerHTML += html;
    });


    /* --------------------------
       VALUE GETTER
    ---------------------------*/
    function getVal(id, isInt = false) {
      const el = document.getElementById(id);
      if(!el || !el.value) return 0;
      return isInt ? parseInt(el.value, 10) : parseFloat(el.value);
    }


    /* --------------------------
       CALCULATION LOGIC
    ---------------------------*/
    function calculate() {
      let results = [];

      subjects.forEach((s, i) => {

        const id = "s" + i;

        const sessinal = getVal(id + "_i1");
        const assignment = getVal(id + "_i2");
        const labManual = getVal(id + "_pract");
        const lpw = getVal(id + "_viva");
        
        // FORCED INTEGER for grade
        const grade = getVal(id + "_grade", true);
        const reqPercent = gradeToPercent[grade] || 0;

        let internal = 0;

        if (s.type === "simple") {
          internal =
            (sessinal / 50) * 25 +
            (assignment / 50) * 25;

        } else {
          internal =
            (sessinal / 50) * 15 +
            (assignment / 40) * 10 +
            (labManual / 100) * 15 +
            (lpw / 40) * 10;
        }

        const requiredSEE = Math.ceil((reqPercent - internal) / 0.5);

        results.push({
          subject: s.name,
          sessinal,
          assignment,
          labManual,
          lpw,
          grade,
          internal,
          requiredSEE
        });
      });

      let totalGrade = 0;
      results.forEach(r => totalGrade += (parseInt(r.grade) || 0));
      const sgpa = totalGrade / 6;
      document.getElementById("sgpaBox").innerHTML = sgpa.toFixed(2);

      return results;
    }


    /* --------------------------
       SHOW REQUIRED + SAVE (Unchanged)
    ---------------------------*/
    window.showRequired = async function (id, index) {
      const user = auth.currentUser;
      if (!user) {
        alert("Please login first!");
        return;
      }

      const results = calculate();   // Full results array
      const r = results[index];      // Only for UI

      // Show result
      const box = document.getElementById(id + "_result");
      box.style.display = "block";

      if (r.requiredSEE <= 0) {
        box.className = "result green";
        box.innerHTML = "‚úÖ Already Achieved! (0 marks needed)";
      } else if (r.requiredSEE > 100) {
        box.className = "result red";
        box.innerHTML = "‚ö†Ô∏è Impossible! Need " + r.requiredSEE + "/100";
      } else {
        box.className = "result yellow";
        box.innerHTML = "Need <b>" + r.requiredSEE + "</b> marks in SEE";
      }

      // Save to Firebase
      await addDoc(collection(db, "student_attempts"), {
        email: user.email,
        data: [...results], 
        timestamp: serverTimestamp()
      });

    };

    /* --------------------------
       FAQ TOGGLE
    ---------------------------*/
    window.toggleFaq = function(el) {
        el.classList.toggle("active");
    };

    /* --------------------------
       AUTH & DATA LOADING
    ---------------------------*/
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
         window.location.href = "/"; // Redirect if not logged in
         return;
      }

      // Update Header UI
      document.getElementById("userName").textContent = user.displayName || "Student";
      document.getElementById("userEmail").textContent = user.email;
      if(user.photoURL) document.getElementById("userPhoto").src = user.photoURL;

      // Get the LAST saved attempt
      const q = query(
        collection(db, "student_attempts"),
        where("email", "==", user.email),
        orderBy("timestamp", "desc")
      );

      const snap = await getDocs(q);
      if (snap.empty) return;

      const last = snap.docs[0].data().data; // full array

      // If somehow not array ‚Üí fix it
      let results = last;
      if (!Array.isArray(results)) results = [results];

      results.forEach((d, i) => {
        const id = "s" + i;

        if(document.getElementById(id + "_i1")) document.getElementById(id + "_i1").value = d.sessinal ?? "";
        if(document.getElementById(id + "_i2")) document.getElementById(id + "_i2").value = d.assignment ?? "";

        if (subjects[i].type === "complex") {
          if(document.getElementById(id + "_pract")) document.getElementById(id + "_pract").value = d.labManual ?? "";
          if(document.getElementById(id + "_viva")) document.getElementById(id + "_viva").value = d.lpw ?? "";
        }

        if(document.getElementById(id + "_grade")) document.getElementById(id + "_grade").value = d.grade ?? "";
      });

      calculate();
    });

    /* --------------------------
       LOGOUT
    ---------------------------*/
    document.getElementById("logout").onclick = () => {
      signOut(auth);
      window.location.href = "/";
    };

  </script>

</body>
</html>
